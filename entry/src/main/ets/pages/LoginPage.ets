// LoginPage.ets
import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { UserModel } from '../models/UserModel';
import prompt from '@ohos.promptAction';

@Entry
@Component
struct LoginPage {
  // å“åº”å¼çŠ¶æ€ç®¡ç†
  @State username: string = '';
  @State password: string = '';
  @State showPassword: boolean = false;
  @State rememberMe: boolean = false;
  @State isLoading: boolean = false;

  // è·å–UIä¸Šä¸‹æ–‡
  private context = getContext(this) as common.UIAbilityContext;

  build() {
    Column() {
      // é¡¶éƒ¨LogoåŒºåŸŸ
      this.buildLogoSection()

      // ç™»å½•è¡¨å•
      this.buildLoginForm()

      // æ“ä½œåŒºåŸŸ
      this.buildActionSection()

      // åº•éƒ¨é“¾æ¥
      this.buildBottomLinks()
    }
    .width('100%')
    .height('100%')
    .padding(24)
    .backgroundColor('#F5F7FA')
  }

  // LogoåŒºåŸŸ
  @Builder
  buildLogoSection() {
    Column() {
      Image($r('app.media.app_logo'))
        .width(120)
        .height(120)
        .margin({ top: 80, bottom: 40 })

      Text('è®¢å•ç®¡ç†ç³»ç»Ÿ')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')
        .margin({ bottom: 60 })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Center)
  }

  // ç™»å½•è¡¨å•
  @Builder
  buildLoginForm() {
    Column() {
      // ç”¨æˆ·åè¾“å…¥
      TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å/æ‰‹æœºå·', text: this.username })
        .width('100%')
        .height(56)
        .fontSize(16)
        .padding({ left: 16, right: 16 })
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .onChange((value: string) => {
          this.username = value;
        })
        .margin({ bottom: 20 })

      // å¯†ç è¾“å…¥
      Row() {
        // æ­£ç¡®çš„æ–¹å¼ï¼šä½¿ç”¨inputTypeå±æ€§æ–¹æ³•è€Œä¸æ˜¯æ„é€ å‡½æ•°å‚æ•°
        TextInput({
          placeholder: 'è¯·è¾“å…¥å¯†ç ',
          text: this.password
        })
          .width('95%')
          .height('100%')
          .fontSize(16)
          .padding({ left: 16 })
          .backgroundColor('#FFFFFF')
          .border({ width: 0 })
          .onChange((value: string) => {
            this.password = value;
          })
          .type(this.showPassword ? InputType.Normal : InputType.Password)  // æ­£ç¡®æ–¹å¼
          //.showPasswordIcon(false)  // ç¦æ­¢æ˜¾ç¤ºç³»ç»Ÿé»˜è®¤çš„å¯†ç å›¾æ ‡

        // åˆ‡æ¢å¯†ç æ˜¾ç¤º/éšè—
        // Column()
        //   .width(40)
        //   .height('100%')  // ä½¿ç”¨100%é«˜åº¦
        //   .justifyContent(FlexAlign.Center)  // å‚ç›´å±…ä¸­
        //   .alignItems(HorizontalAlign.Center)  // æ°´å¹³å±…ä¸­
        //   .onClick(() => {
        //     this.showPassword = !this.showPassword;
        //   })
          //.overlay(this.overlayEyeIcon(this.showPassword))

        // Image(this.showPassword ? $r('app.media.ic_visibility') : $r('app.media.ic_visibility_off'))
        //   .width(24)
        //   .height(24)
        //   .margin({ left: 12 })
        //   .onClick(() => {
        //     this.showPassword = !this.showPassword;
        //   })
      }
      .width('100%')
      .height(56)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .padding({ right: 16 })
      .alignItems(VerticalAlign.Center)  // æ·»åŠ å‚ç›´å¯¹é½
      .margin({ bottom: 16 })

      // è®°ä½å¯†ç å’Œå¿˜è®°å¯†ç 
      Row() {
        Checkbox({ name: 'remember', group: 'login' })
          .select(this.rememberMe)
          .onChange((value: boolean) => {
            this.rememberMe = value;
          })
          .margin({ right: 8 })

        Text('è®°ä½å¯†ç ')
          .fontSize(14)
          .fontColor('#666666')
          .onClick(() => {
            this.rememberMe = !this.rememberMe;
          })

        Blank()

        Text('å¿˜è®°å¯†ç ?')
          .fontSize(14)
          .fontColor('#007DFF')
          .onClick(() => {
            this.navigateToForgotPassword();
          })
      }
      .width('100%')
      .height(40)
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 40 })
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({ radius: 16, color: '#1A1A1A1A', offsetX: 0, offsetY: 4 })
  }

  @Builder
  overlayEyeIcon(showPassword: boolean) {
    Text(showPassword ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸')
      .fontSize(20)
      .fontColor(showPassword ? '#007DFF' : '#999999')
  }

  // æ“ä½œæŒ‰é’®åŒºåŸŸ
  @Builder
  buildActionSection() {
    Column() {
      // ç™»å½•æŒ‰é’®
      Button('ç™»å½•', { type: ButtonType.Capsule })
        .width('100%')
        .height(56)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .backgroundColor('#007DFF')
        .stateEffect(true)
        .onClick(() => {
          this.handleLogin();
        })
        .opacity(this.isLoading ? 0.7 : 1)
        .enabled(!this.isLoading)

      // åŠ è½½æŒ‡ç¤ºå™¨
      if (this.isLoading) {
        LoadingProgress()
          .color('#FFFFFF')
          .margin({ top: 8 })
      }

    }
    .width('100%')
    .margin({ top: 40 })
    .alignItems(HorizontalAlign.Center)
  }

  // åº•éƒ¨é“¾æ¥
  @Builder
  buildBottomLinks() {
    Column() {
      Row() {
        Text('è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ')
          .fontSize(14)
          .fontColor('#666666')

        Text('ç«‹å³æ³¨å†Œ')
          .fontSize(14)
          .fontColor('#007DFF')
          .fontWeight(FontWeight.Medium)
          .margin({ left: 4 })
          .onClick(() => {
            this.navigateToRegister();
          })
      }
      .margin({ top: 40, bottom: 20 })

      Text('ã€Šç”¨æˆ·åè®®ã€‹ | ã€Šéšç§æ”¿ç­–ã€‹')
        .fontSize(12)
        .fontColor('#999999')
        .onClick(() => {
          this.showAgreement();
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Center)
    .margin({ top: 40 })
  }

  // ç™»å½•é€»è¾‘
  private async handleLogin() {
    if (!this.validateInput()) {
      return;
    }

    this.isLoading = true;

    try {
      const userModel = new UserModel();
      const result = await userModel.login({
        username: this.username,
        password: this.password
      });

      if (result.success) {
        // ä¿å­˜ç™»å½•çŠ¶æ€
        await userModel.saveLoginInfo(this.username, this.rememberMe);

        // è·³è½¬åˆ°ä¸»é¡µé¢
        router.replaceUrl({
          url: 'pages/HomePage',
          params: { userId: result.userId }
        });
      } else {
        this.showToast('ç™»å½•å¤±è´¥: ' + result.message);
      }
    } catch (error) {
      this.showToast('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•');
    } finally {
      this.isLoading = false;
    }
  }

  // è¾“å…¥éªŒè¯
  private validateInput(): boolean {
    if (!this.username.trim()) {
      this.showToast('è¯·è¾“å…¥ç”¨æˆ·å');
      return false;
    }

    if (!this.password) {
      this.showToast('è¯·è¾“å…¥å¯†ç ');
      return false;
    }

    if (this.password.length < 6) {
      this.showToast('å¯†ç é•¿åº¦è‡³å°‘6ä½');
      return false;
    }

    return true;
  }

  // æ˜¾ç¤ºToastæç¤º
  private showToast(message: string) {
    prompt.showToast({
      message: message,
      duration: 2000,
      bottom: 200
    });
  }

  // é¡µé¢è·³è½¬æ–¹æ³•
  private navigateToForgotPassword() {
    router.pushUrl({
      url: 'pages/ForgotPasswordPage'
    });
  }

  private navigateToRegister() {
    router.pushUrl({
      url: 'pages/RegisterPage'
    });
  }

  private wechatLogin() {
    // å¾®ä¿¡ç™»å½•é€»è¾‘
    // éœ€è¦é›†æˆå¾®ä¿¡SDK
  }

  private alipayLogin() {
    // æ”¯ä»˜å®ç™»å½•é€»è¾‘
    // éœ€è¦é›†æˆæ”¯ä»˜å®SDK
  }

  private showAgreement() {
    router.pushUrl({
      url: 'pages/AgreementPage',
      params: { type: 'user' }
    });
  }
}